<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Website Biz OpenAI Control Center</title>
  <style>
    body{font-family:Inter,system-ui;background:#0b1020;color:#eef4ff;margin:0}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .card{background:#131b2f;border:1px solid #263455;border-radius:12px;padding:14px}
    input,textarea{width:100%;margin-top:6px;background:#0d1426;color:#eef4ff;border:1px solid #33456c;border-radius:8px;padding:8px}
    button{margin-top:8px;background:#5eead4;color:#03201d;border:0;padding:9px 12px;border-radius:8px;font-weight:700;cursor:pointer}
    pre{background:#0b1428;padding:12px;border-radius:10px;white-space:pre-wrap;max-height:320px;overflow:auto}
    h1{margin:8px 0 14px}
    .muted{color:#9fb0d3}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Website Biz OpenAI â€” Full Operations Control Center</h1>
  <p class="muted">All major functions are available below: setup check, scraping, enrichment, website generation, templates, outreach, daily automation, and status.</p>

  <div class="grid">
    <div class="card"><h3>Setup Check</h3><button onclick="run('check')">Run Check</button></div>
    <div class="card"><h3>Status</h3><button onclick="run('status')">Refresh Status</button></div>
    <div class="card"><h3>History</h3><button onclick="run('history',{limitPerFile:50})">View Past Scrapes + Websites + Outreach</button></div>

    <div class="card"><h3>Scrape Leads</h3>
      <label>Industry<input id="q" value="plumbers"></label>
      <label>City<input id="loc" value="Austin TX"></label>
      <label>Max results<input id="max" value="60"></label>
      <button onclick="run('scrape',{query:v('q'),location:v('loc'),maxResults:Number(v('max'))},true)">Scrape (Queue)</button>
      <button onclick="runLocalScrape()">Run Scrape Locally</button>
      <p class="muted">Local button opens your local runner at http://localhost:8787 and runs scrape there.</p>
    </div>

    <div class="card"><h3>Enrich Leads</h3>
      <label>Leads file<input id="lf" value="/tmp/website-biz/leads-plumbers-austin-tx.json"></label>
      <button onclick="run('enrich',{leadsFile:v('lf')})">Enrich</button>
    </div>

    <div class="card"><h3>Generate Website</h3>
      <label>Leads file<input id="glf" value="/tmp/website-biz/leads-plumbers-austin-tx.json"></label>
      <label>Lead index<input id="idx" value="0"></label>
      <button onclick="run('generate-site',{leadsFile:v('glf'),index:Number(v('idx'))})">Generate</button>
    </div>

    <div class="card"><h3>Send Outreach</h3>
      <label>Leads file<input id="slf" value="/tmp/website-biz/leads-plumbers-austin-tx.json"></label>
      <button onclick="run('send',{leadsFile:v('slf')})">Send</button>
    </div>

    <div class="card"><h3>Template: Add</h3>
      <label>Name<input id="tn" value="Quick opener"></label>
      <label>Subject<input id="ts" value="Built this for {{business_name}}"></label>
      <label>Body<textarea id="tb">Hey {{business_name}}, I built a quick concept: {{website_url}}</textarea></label>
      <button onclick="run('template-add',{name:v('tn'),subject:v('ts'),body:v('tb')})">Add Template</button>
      <button onclick="run('template-list')">List Templates</button>
    </div>

    <div class="card"><h3>Template: Default/Delete</h3>
      <label>Template name<input id="tdn" value="Quick opener"></label>
      <button onclick="run('template-default',{name:v('tdn')})">Set Default</button>
      <button onclick="run('template-delete',{name:v('tdn')})">Delete</button>
    </div>

    <div class="card"><h3>Daily Automation</h3>
      <label>Industry<input id="dq" value="plumbers"></label>
      <label>City<input id="dl" value="Austin TX"></label>
      <button onclick="run('daily-set',{query:v('dq'),location:v('dl')})">Set Target</button>
      <button onclick="run('daily-run')">Run Daily</button>
      <button onclick="run('daily-run',{},true)">Queue Daily Run</button>
    </div>

    <div class="card"><h3>Jobs</h3>
      <button onclick="run('job-list',{limit:25})">List Jobs</button>
      <label>Job ID<input id="jid"></label>
      <button onclick="run('job-get',{id:v('jid')})">Get Job</button>
      <p class="muted">Async jobs are queued via actions with async=true.</p>
    </div>
  </div>

  <h3>Output</h3>
  <pre id="out">Ready.</pre>
</div>
<script>
const out=document.getElementById('out');
const v=(id)=>document.getElementById(id).value;
async function run(action, params={}, isAsync=false){
  out.textContent='Running '+action+'...';
  try{
    const r=await fetch('/api/run',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action,params,async:isAsync})});
    const j=await r.json();
    out.textContent=JSON.stringify(j,null,2);
  }catch(e){out.textContent='ERROR: '+e.message}
}

function runLocalScrape(){
  const query = encodeURIComponent(v('q'));
  const location = encodeURIComponent(v('loc'));
  const max = encodeURIComponent(String(Number(v('max') || 60)));
  const url = `http://localhost:8787/?autoLocalScrape=1&q=${query}&loc=${location}&max=${max}`;

  const isLocalHost = ['localhost', '127.0.0.1'].includes(window.location.hostname);
  if (!isLocalHost) {
    out.textContent = [
      'Local scrape can only run on your Mac browser (localhost).',
      '',
      'From phone/prod, use "Scrape (Queue)" instead.',
      'Then keep your Mac worker running to process queued jobs.',
      '',
      `Local runner link (open on Mac): ${url}`
    ].join('\n');
    return;
  }

  window.open(url, '_blank', 'noopener');
}

(async function autoRunLocalFromQuery(){
  const sp = new URLSearchParams(window.location.search);
  if (sp.get('autoLocalScrape') !== '1') return;
  const q = sp.get('q') || v('q');
  const loc = sp.get('loc') || v('loc');
  const max = Number(sp.get('max') || v('max') || 60);
  document.getElementById('q').value = q;
  document.getElementById('loc').value = loc;
  document.getElementById('max').value = String(max);
  await run('scrape', { query: q, location: loc, maxResults: max }, false);
})();
</script>
</body>
</html>
